name: Orion Coding Agent

on:
  repository_dispatch:
    types: [run-agent]

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch }}

      - name: Build Agent Container
        run: docker build -t orion-agent ./agent

      - name: Run Coding Agent
        run: |
          docker run --rm \
            -e TASK="${{ github.event.client_payload.task }}" \
            -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            orion-agent

      - name: Commit Changes
        run: |
          git config user.name "orion-bot"
          git config user.email "bot@orion.ai"
          git add .
          git commit -m "ðŸ¤– AutoDev Task Complete"
          git push origin HEAD

      - name: Open Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ github.event.client_payload.branch }}
          title: "ðŸ¤– AutoDev: ${{ github.event.client_payload.task }}"
          body: "Automated changes generated by Orion Coding Agent"
